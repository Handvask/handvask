# // Some information which was automatically generated by the Cloud Build.
# steps:
#   - name: gcr.io/cloud-builders/docker
#     args:
#       - build
#       - '--no-cache'
#       - '-t'
#       - '$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'
#       - python_backend
#       - '-f'
#       - python_backend/Dockerfile
#     id: Build
#   - name: gcr.io/cloud-builders/docker
#     args:
#       - push
#       - '$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'
#     id: Push
#   - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
#     args:
#       - run
#       - services
#       - update
#       - $_SERVICE_NAME
#       - '--platform=managed'
#       - '--image=$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'
#       - >-
#         --labels=managed-by=gcp-cloud-build-deploy-cloud-run,commit-sha=$COMMIT_SHA,gcb-build-id=$BUILD_ID,gcb-trigger-id=$_TRIGGER_ID,$_LABELS
#       - '--region=$_DEPLOY_REGION'
#       - '--quiet'
#     id: Deploy
#     entrypoint: gcloud
# images:
#   - '$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'
# options:
#   substitutionOption: ALLOW_LOOSE
# substitutions:
#   _LABELS: gcb-trigger-id=f02c9be6-5614-445c-8cc2-3dad3b27a037
#   _TRIGGER_ID: f02c9be6-5614-445c-8cc2-3dad3b27a037
#   _GCR_HOSTNAME: eu.gcr.io
#   _PLATFORM: managed
#   _SERVICE_NAME: handvask
#   _DEPLOY_REGION: europe-north1
# tags:
#   - gcp-cloud-build-deploy-cloud-run
#   - gcp-cloud-build-deploy-cloud-run-managed
#   - handvask

steps:
  # Docker Build
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'europe-north1-docker.pkg.dev/$PROJECT_ID/handvask-artifacts/$_SUB_VALUE-image:$COMMIT_SHA', ./python_backend]
# Docker Push
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'europe-north1-docker.pkg.dev/$PROJECT_ID/handvask-artifacts/$_SUB_VALUE-image:$COMMIT_SHA']
# Entrypoint, timeout and environment variables
# - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
#   entrypoint: 'gcloud'
#   timeout: 240s
#   args: ['compute', 'instances', 
#            'create-with-container', 'handvask',
#            '--container-image', 
#            '$_DEPLOY_REGION-docker.pkg.dev/$PROJECT_ID/handvask-artifacts/$_SERVICE_NAME:$COMMIT_SHA']
#   env:
#       - 'CLOUDSDK_COMPUTE_REGION=europe-north1'
#       - 'CLOUDSDK_COMPUTE_ZONE=europe-north1-a'

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
  args:
    - run
    - services
    - update
    - $_SUB_VALUE-image
    - '--platform=managed'
    - '--image=$_GCR_HOSTNAME/$PROJECT_ID/handvask-artifacts/$_SUB_VALUE-image:$COMMIT_SHA'
    - >-
      --labels=managed-by=gcp-cloud-build-deploy-cloud-run,commit-sha=$COMMIT_SHA,gcb-build-id=$BUILD_ID,gcb-trigger-id=$_TRIGGER_ID,$_LABELS
    - '--region=$_DEPLOY_REGION'
    - '--quiet'
  id: Deploy
  entrypoint: gcloud
substitutions:
  _SUB_VALUE: python-backend
  _LABELS: gcb-trigger-id=68c844f1-4174-4817-9f3f-222ee4d501c3
  _TRIGGER_ID: 68c844f1-4174-4817-9f3f-222ee4d501c3
  _GCR_HOSTNAME: europe-north1-docker.pkg.dev
  _PLATFORM: managed
  _SERVICE_NAME: handvask
  _DEPLOY_REGION: europe-north1
images:
  - '$_GCR_HOSTNAME/$PROJECT_ID/handvask-artifacts/$_SUB_VALUE-image:$COMMIT_SHA'
  #  europe-north1-docker.pkg.dev/handvask/handvask-artifacts/$_SERVICE_NAME
options:
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: ALLOW_LOOSE
tags:
  - gcp-cloud-build-deploy-cloud-run
  - gcp-cloud-build-deploy-cloud-run-managed
  - handvask
