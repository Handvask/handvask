# // Some information which was automatically generated by the Cloud Build.
# steps:
#   - name: gcr.io/cloud-builders/docker
#     args:
#       - build
#       - '--no-cache'
#       - '-t'
#       - '$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'
#       - python_backend
#       - '-f'
#       - python_backend/Dockerfile
#     id: Build
#   - name: gcr.io/cloud-builders/docker
#     args:
#       - push
#       - '$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'
#     id: Push
#   - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
#     args:
#       - run
#       - services
#       - update
#       - $_SERVICE_NAME
#       - '--platform=managed'
#       - '--image=$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'
#       - >-
#         --labels=managed-by=gcp-cloud-build-deploy-cloud-run,commit-sha=$COMMIT_SHA,gcb-build-id=$BUILD_ID,gcb-trigger-id=$_TRIGGER_ID,$_LABELS
#       - '--region=$_DEPLOY_REGION'
#       - '--quiet'
#     id: Deploy
#     entrypoint: gcloud
# images:
#   - '$_GCR_HOSTNAME/$PROJECT_ID/$REPO_NAME/$_SERVICE_NAME:$COMMIT_SHA'
# options:
#   substitutionOption: ALLOW_LOOSE
# substitutions:
#   _LABELS: gcb-trigger-id=f02c9be6-5614-445c-8cc2-3dad3b27a037
#   _TRIGGER_ID: f02c9be6-5614-445c-8cc2-3dad3b27a037
#   _GCR_HOSTNAME: eu.gcr.io
#   _PLATFORM: managed
#   _SERVICE_NAME: handvask
#   _DEPLOY_REGION: europe-north1
# tags:
#   - gcp-cloud-build-deploy-cloud-run
#   - gcp-cloud-build-deploy-cloud-run-managed
#   - handvask

steps:
  # Docker Build
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "europe-north1-docker.pkg.dev/handvask/handvask-artifacts/python_backend:latest",
        "./python_backend",
      ]
  # Docker Push
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "europe-north1-docker.pkg.dev/handvask/handvask-artifacts/python_backend:latest",
      ]
    # Entrypoint, timeout and environment variables
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "gcloud"
    timeout: 240s
    args:
      [
        "compute",
        "instances",
        "create-with-container",
        "handvask",
        "--container-image",
        "europe-north1-docker.pkg.dev/handvask/handvask-artifacts/python_backend:latest",
      ]
    env:
      - "CLOUDSDK_COMPUTE_REGION=europe-north1"
      - "CLOUDSDK_COMPUTE_ZONE=europe-north1-a"
options:
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: ALLOW_LOOSE
